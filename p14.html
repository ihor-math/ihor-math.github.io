<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>14. Визначник 3-го порядку</title>
    <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                packages: ['base', 'ams', 'autoload'],
                tags: 'ams'
            },
            chtml: {
                fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
            },
            startup: {
                ready: () => {
                    console.log('MathJax is initialized');
                    MathJax.startup.defaultReady();
                    window.mathJaxReady = true;
                }
            }
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        *, *:before, ::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            background: linear-gradient(135deg, #1c2b1a, #3a4c36);
            font-family: 'Poppins', sans-serif;
            color: #e8e8e8;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100dvh;
        }
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        .title-box {
            margin-top: 60px;
            padding: 25px 40px;
            background: linear-gradient(135deg, #2b2b2b, #4c6b3a);
            border-radius: 25px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), inset 0 0 10px rgba(255, 255, 255, 0.1);
            max-width: 90%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .title-box h1 {
            font-size: 28px;
            color: #d4d4d4;
            text-shadow: 0 0 10px rgba(212, 212, 212, 0.5);
            font-weight: 800;
        }
        .section-container {
            margin-top: 40px;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        .section {
            width: 250px;
            height: 220px;
            background: linear-gradient(135deg, #2e4c2b, #4c6b3a);
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3), inset 0 0 8px rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            color: inherit;
            border: 1px solid rgba(163, 166, 139, 0.3);
        }
        .section:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.5), inset 0 0 12px rgba(163, 166, 139, 0.2);
        }
        .section img {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            object-fit: cover;
            border-radius: 8px;
            filter: drop-shadow(0 0 5px rgba(163, 166, 139, 0.3));
        }
        .section h2 {
            font-size: 20px;
            color: #e8e8e8;
            font-weight: 600;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 95%;
            max-width: 95vw;
            height: 95vh;
            max-height: 95vh;
            background: linear-gradient(135deg, #1c2b1a, #3a4c36);
            z-index: 1001;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            transition: opacity 0.25s ease, transform 0.25s ease;
            opacity: 0;
            border-radius: 15px;
            overflow: hidden;
            transform: translateZ(0);
        }
        .modal.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .modal-header {
            background: linear-gradient(90deg, #2b2b2b, #4c6b3a);
            padding: 8px 12px;
            display: flex;
            justify-content: flex-end;
            width: 100%;
            flex-shrink: 0;
        }
        .close-btn {
            background: #a3a68b;
            color: #1c2b1a;
            border: none;
            border-radius: 6px;
            padding: 6px 16px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .close-btn:hover {
            background: #7a7d66;
        }
        .modal-content {
            padding: 20px;
            flex-grow: 1;
            background: linear-gradient(135deg, #4c6b3a, #2b2b2b);
            border-radius: 10px;
            margin: 10px;
            color: #e8e8e8;
            width: 100%;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(163, 166, 139, 0.5) transparent;
        }
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: transparent;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(163, 166, 139, 0.5);
            border-radius: 3px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(163, 166, 139, 0.8);
        }
        .video-card-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }
        .video-card {
            width: 350px;
            height: 250px;
            background: linear-gradient(135deg, #2e4c2b, #4c6b3a);
            border-radius: 15px;
            border: 1px solid rgba(163, 166, 139, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            color: #e8e8e8;
        }
        .video-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        .video-card img {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            object-fit: cover;
            border-radius: 6px;
        }
        .video-card h3 {
            font-size: clamp(16px, 2.5vw, 18px);
            font-weight: 600;
        }
        .video-player-container {
            max-width: 95%;
            margin: 0 auto;
        }
        .video-player-container iframe {
            width: 100%;
            aspect-ratio: 16 / 9;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .glow-title {
            text-align: center;
            font-size: 2em;
            color: #e8e8e8;
            font-family: 'Verdana', sans-serif;
            text-shadow: 0 0 10px #e8e8e8, 0 0 20px #a3a68b, 0 0 30px #a3a68b;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from {
                text-shadow: 0 0 5px #e8e8e8, 0 0 10px #a3a68b;
            }
            to {
                text-shadow: 0 0 20px #e8e8e8, 0 0 30px #a3a68b;
            }
        }
        #theoryModal .modal-content p {
            font-size: 18px !important;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: justify;
            max-width: 100%;
        }
        #theoryModal .modal-content ul {
            list-style: none;
            padding-left: 20px;
        }
        #theoryModal .modal-content li {
            color: #e8e8e8;
            padding-left: 20px;
            margin-left: 10px;
            max-width: calc(100% - 30px);
            white-space: normal;
            text-align: justify;
            position: relative;
        }
        #theoryModal .modal-content li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #a3a68b;
            font-size: 16px;
        }
        #theoryModal .modal-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #theoryModal .math-notation-centered {
            display: block !important;
            color: #FFFF00 !important;
            text-align: center !important;
            max-width: 100%;
            width: fit-content;
            margin: 10px auto;
            padding: 5px;
            box-sizing: border-box;
        }
        #theoryModal mjx-container {
            color: #FFFF00 !important;
            font-size: clamp(16px, 2.8vw, 18px);
        }
        #theoryModal mjx-container[jax="CHTML"][display="true"] {
            display: block !important;
            text-align: center !important;
            margin: 10px auto !important;
            max-width: 100% !important;
            width: fit-content !important;
            padding: 5px !important;
            box-sizing: border-box !important;
            overflow: visible !important;
        }
        #trainerModal mjx-container {
            font-size: clamp(16px, 2.8vw, 18px);
            color: #FFFF00;
            max-width: 90%;
            width: fit-content;
            margin: 10px auto;
            padding: 5px;
            box-sizing: border-box;
            text-align: center;
        }
        #trainerModal mjx-container[jax="CHTML"][display="true"] {
    font-size: clamp(18px, 3vw, 20px) !important;
    display: block !important;
    text-align: center !important;
    margin: 10px auto !important;
    max-width: 90% !important;
    width: fit-content !important;
    padding: 5px !important;
    box-sizing: border-box !important;
    overflow: visible !important;
}
#trainerModal mjx-container {
    font-size: clamp(18px, 3vw, 19px) !important;
}
.mathjax-loading::before {
    content: 'Завантаження формул...';
    display: block;
    text-align: center;
    color: #e8e8e8;
    margin: 10px 0;
}

        #questionsModal mjx-container {
            font-size: clamp(16px, 2.8vw, 18px);
            color: #FFFF00;
            max-width: 90%;
            width: fit-content;
            margin: 5px auto;
            padding: 3px;
            box-sizing: border-box;
            text-align: center;
            overflow: visible !important;
        }
        #questionsModal mjx-container[jax="CHTML"][display="true"] {
            display: block !important;
            text-align: center !important;
            margin: 5px auto !important;
            max-width: 90% !important;
            width: fit-content !important;
            padding: 3px !important;
            box-sizing: border-box !important;
            overflow: visible !important;
        }
        #modalOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            transition: opacity 0.25s ease;
            transform: translateZ(0);
        }
        
        .question-card {
            perspective: 1000px;
            margin: 20px auto;
            max-width: 95%;
            height: 200px;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            cursor: pointer;
        }
        .card-inner.flipped {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            padding: 12px;
            border-radius: 15px;
            font-size: clamp(16px, 3vw, 18px);
            line-height: 1.5;
            border: 1px solid rgba(163, 166, 139, 0.3);
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
        }
        .card-front {
            background: linear-gradient(135deg, #2e4c2b, #4c6b3a);
            color: #e8e8e8;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-wrap: wrap;
            overflow-wrap: break-word;
            word-break: break-word;
            padding: 12px 15px;
            max-width: 100%;
        }
        .card-back {
            background: linear-gradient(135deg, #3a3a3a, #575a4b);
            color: #e8e8e8;
            transform: rotateY(180deg);
            overflow-y: auto;
            text-align: justify;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100%;
            word-break: break-word;
            overflow-wrap: break-word;
            padding: 12px 15px;
            max-width: 100%;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: rgba(163, 166, 139, 0.5) transparent;
        }
        .card-back::-webkit-scrollbar {
            width: 6px;
        }
        .card-back::-webkit-scrollbar-track {
            background: transparent;
        }
        .card-back::-webkit-scrollbar-thumb {
            background: rgba(163, 166, 139, 0.5);
            border-radius: 3px;
        }
        .card-back::-webkit-scrollbar-thumb:hover {
            background: rgba(163, 166, 139, 0.8);
        }
        .question-card .card-front {
            white-space: normal;
            overflow-wrap: break-word;
            word-break: break-word;
            flex-wrap: wrap;
        }
        .card-back p {
            margin: 5px 0;
            font-size: clamp(16px, 3vw, 18px);
            color: #e8e8e8;
            box-sizing: border-box;
            width: 100%;
            text-align: center;
        }
        .card-front span.yellow {
            color: #FFFF00;
            font-weight: 600;
            display: inline;
            margin-right: 0.1em;
        }
        #trainerModal .modal-content {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            background: linear-gradient(135deg, #4c6b3a, #2b2b2b);
            border-radius: 10px;
            margin: 10px;
            color: #e8e8e8;
            width: auto;
            min-width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: auto;
        }
        .trainer-container {
            width: 95%;
            max-width: 900px;
            padding: 4vw 5vw;
            text-align: center;
            background: linear-gradient(135deg, #2e4c2b, #4c6b3a);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(163, 166, 139, 0.3);
            box-sizing: border-box;
            margin: auto;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(163, 166, 139, 0.5) transparent;
        }
        .trainer-container::-webkit-scrollbar {
            width: 6px;
        }
        .trainer-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .trainer-container::-webkit-scrollbar-thumb {
            background: rgba(163, 166, 139, 0.5);
            border-radius: 3px;
        }
        .trainer-container::-webkit-scrollbar-thumb:hover {
            background: rgba(163, 166, 139, 0.8);
        }
        .trainer-container p {
            font-size: clamp(18px, 3vw, 20px);
            color: #e8e8e8;
            margin: 10px 0;
        }
        .trainer-container .math-notation-centered {
            text-align: center !important;
            margin: 10px 0;
            max-width: 90%;
        }
        .trainer-question {
            font-size: clamp(18px, 3vw, 20px);
            color: #e8e8e8;
            margin-bottom: 15px;
            text-align: center;
        }
        .question-number {
            width: 100px;
            height: 100px;
            line-height: 100px;
            background: linear-gradient(135deg, #a3a68b, #7a7d66);
            color: #1c2b1a;
            border-radius: 50%;
            font-size: clamp(16px, 2.8vw, 18px);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            text-align: center;
            white-space: nowrap;
        }
        .answer-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        .answer-btn {
    background: linear-gradient(135deg, #2b2b2b, #4c6b3a);
    color: #e8e8e8;
    border: 1px solid rgba(163, 166, 139, 0.3);
    border-radius: 8px;
    padding: 10px 20px;
    font-size: clamp(17px, 2.6vw, 18px); 
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s ease;
    min-width: 120px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
                                touch-action: manipulation; /* Покращення взаємодії на сенсорних екранах */
}
        .answer-btn:hover {
            background: linear-gradient(135deg, #4c6b3a, #575a4b);
            transform: scale(1.05);
        }
        .answer-btn:disabled {
            background: #575a4b;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .answer-btn.selected {
            background: linear-gradient(135deg, #a3a68b, #7a7d66);
            color: #1c2b1a;
        }
        .submit-btn {
            background: #556832;
            color: #fbec5d;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: clamp(14px, 2.5vw, 16px);
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            margin: 15px auto;
            display: block;
        }
        .submit-btn:hover {
            background: linear-gradient(135deg, #7a7d66, #a3a68b);
            transform: scale(1.05);
        }
        .submit-btn:disabled {
            background: #c3ceb9;
            cursor: not-allowed;
            opacity: 0.6;
            color: #2e4c2b;
        }
        /* Feedback box styling */
#feedback {
    position: absolute; /* Абсолютне позиціонування */
    top: 50%; /* Розміщення на 50% від верхнього краю */
    left: 50%; /* Розміщення на 50% від лівого краю */
    transform: translate(-50%, -50%); /* Зміщення на половину ширини/висоти елемента */
    margin: 0; /* Прибираємо margin, щоб уникнути зміщення */
    padding: 15px 25px;
    max-width: 400px;
             min-height: 80px; /* Збільшуємо висоту прямокутника */
    width: 90%; /* Адаптивна ширина для малих екранів */
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    font-size: clamp(16px, 2.8vw, 18px); /* Адаптивний розмір шрифту */
    font-weight: bold;
    text-align: center; /* Центрування тексту */
    opacity: 0;
    transition: opacity 0.4s ease, transform 0.4s ease;
    z-index: 10; /* Щоб елемент був поверх інших */
            display: flex; /* Додаємо flex для центрування тексту по вертикалі */
    align-items: center; /* Вертикальне центрування тексту */
    justify-content: center; /* Горизонтальне центрування тексту */
}

#feedback.show {
    opacity: 1;
    transform: translate(-50%, -50%); /* Зберігаємо центрування при анімації */
}

#feedback.correct {
    color: #155724;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
}

#feedback.incorrect {
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
}
        #resetTrainerBtn {
            background: #a3a68b;
            color: #2e4c2b;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: clamp(14px, 2.5vw, 16px);
            cursor: pointer;
            transition: background 0.3s ease;
        }
        #resetTrainerBtn:hover {
            background: #7a7d66;
        }
        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 40px auto;
            max-width: 1000px;
            padding: 0 20px;
        }
        .nav-button {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #2b2b2b, #4c6b3a);
            color: #d4d4d4;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(163, 166, 139, 0.3);
            text-decoration: none;
        }
        .nav-button:hover {
            background: linear-gradient(135deg, #4c6b3a, #575a4b);
            color: #e8e8e8;
            text-decoration: none;
        }
        .nav-button svg {
            margin-right: 8px;
            fill: currentColor;
        }
        details {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
            background: linear-gradient(135deg, #2e4c2b, #4c6b3a);
            cursor: pointer;
            border: 1px solid rgba(163, 166, 139, 0.3);
        }
        summary {
            font-weight: 600;
            padding: 10px;
            background: linear-gradient(90deg, #3a3a3a, #575a4b);
            border-radius: 10px;
            color: #d4d4d4;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        summary:hover {
            background: linear-gradient(90deg, #575a4b, #7a7d66);
        }
        details p {
            padding: 0 20px 10px;
            color: #e8e8e8;
        }
        .solution {
            color: #F4A261 !important;
            font-weight: bold;
        }
        .example-title {
            color: #F4A261 !important;
            font-weight: bold;
        }
        .example-condition {
            color: #e8e8e8 !important;
        }
        .completion-emoji {
            font-size: 60px;
            text-align: center;
            margin-bottom: 20px;
        }
        .completion-message {
            text-align: center;
            padding: 20px;
            background: #144748;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(110, 231, 183, 0.3);
            max-width: 90%;
            margin: 20px auto;
        }
        /* === СТИЛІ ДЛЯ МЕДАЛІ З ТРИЗУБОМ === */
.completion-emoji {
    position: relative;
    display: inline-block;
    width: clamp(56px, 12vw, 96px);
    height: clamp(56px, 12vw, 96px);
    vertical-align: middle;
    margin: 0 auto 3vw;
    border-radius: 50%;
    background: linear-gradient(135deg, #1c2526, #2e3a3b);
    border: 3px dashed #ffd700;
    box-shadow: 0 4px 16px rgba(255, 215, 0, 0.3);
    overflow: hidden;
    animation: medalAppear 0.8s ease-out;
}

.completion-emoji::after {
    content: '';
    position: absolute;
    inset: 0;
    background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'>\
<defs>\
<radialGradient id='goldShine' cx='40%' cy='35%' r='70%'>\
<stop offset='0%' stop-color='%23fff59d'/>\
<stop offset='40%' stop-color='%23ffeb3b'/>\
<stop offset='100%' stop-color='%23f9a825'/>\
</radialGradient>\
<filter id='s' x='-50%' y='-50%' width='200%' height='200%'>\
<feDropShadow dx='0' dy='2' stdDeviation='3' flood-color='%23000000' flood-opacity='0.4'/>\
</filter>\
</defs>\
<rect x='30' y='0' width='60' height='40' rx='4' fill='%23007ACC'/>\
<rect x='30' y='20' width='60' height='20' rx='4' fill='%23FFD700'/>\
<g transform='translate(60,70)'>\
<polygon points='0,-26 6,-6 26,-6 9,6 15,26 0,14 -15,26 -9,6 -26,-6 -6,-6' fill='url(%23goldShine)' filter='url(%23s)'/>\
</g>\
</svg>");
    background-size: 75%;
    background-repeat: no-repeat;
    background-position: center 60%;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.25));
    animation: medalBounce 1.2s ease-out 0.3s both;
}

/* Анімація появи кола */
@keyframes medalAppear {
    0% {
        transform: scale(0.3) rotate(-180deg);
        opacity: 0;
    }
    60% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Анімація медалі — падає і блимає */
@keyframes medalBounce {
    0% {
        transform: translateY(-120px) rotate(-30deg) scale(0.4);
        opacity: 0;
    }
    60% {
        transform: translateY(15px) rotate(10deg) scale(1.15);
        opacity: 1;
    }
    80% {
        transform: translateY(-8px) rotate(-5deg) scale(1.05);
    }
    100% {
        transform: translateY(0) rotate(0) scale(1);
    }
}

        .completion-message h2 {
            font-size: clamp(20px, 3.5vw, 24px);
            color: #e6e6e6;
            margin-bottom: 10px;
        }
        .completion-message p {
            font-size: clamp(18px, 3vw, 20px);
            color: #FFFF00;
        }
        .completion-message button {
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .title-box {
                margin-top: 40px;
                padding: 15px 20px;
            }
            .title-box h1 {
                font-size: 24px;
            }
            .section-container {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .section {
                width: 80%;
                height: 180px;
            }
            .modal-content {
                padding: 15px;
                max-height: calc(100dvh - 60px);
                overflow-x: auto;
            }
            .video-card {
                width: 260px;
                height: 160px;
            }
            #theoryModal .modal-content p, #theoryModal .modal-content li {
                font-size: 18px !important;
                line-height: 1.7;
            }
            #theoryModal mjx-container, #theoryModal .math-notation-centered {
                font-size: clamp(18px, 3vw, 20px) !important;
            }
            #trainerModal mjx-container, #questionsModal mjx-container {
                font-size: clamp(18px, 3vw, 20px) !important;
            }
            #trainerModal mjx-container {
    font-size: clamp(14px, 2.5vw, 16px) !important;
}
            .question-card {
                height: 220px;
                max-width: 90%;
            }
            .card-front {
                font-size: clamp(16px, 2.9vw, 18px);
                padding: 10px 12px;
                overflow-wrap: break-word;
                word-break: break-word;
            }
            .card-back {
                padding: 10px 12px;
                font-size: clamp(16px, 2.9vw, 18px);
                justify-content: center;
                align-items: center;
                overflow-y: auto;
            }
            #questionsModal mjx-container {
                font-size: clamp(16px, 3.2vw, 18px) !important;
                max-width: 100%;
                margin: 5px auto;
                padding: 5px;
                overflow: visible !important;
            }
            #questionsModal mjx-container[jax="CHTML"][display="true"] {
                font-size: clamp(16px, 3.2vw, 18px) !important;
                max-width: 100%;
                margin: 5px auto;
                padding: 5px;
                overflow: visible !important;
                text-align: center;
            }
            .card-back p {
                font-size: clamp(16px, 2.9vw, 18px);
                margin: 5px 0;
                text-align: center;
            }
            .trainer-container {
                padding: 4vw 5vw;
                width: 95%;
                max-width: 800px;
            }
            .trainer-container p, .trainer-question {
                font-size: clamp(16px, 2.8vw, 18px);
            }
            .question-number {
                width: 80px;
                height: 80px;
                line-height: 80px;
                font-size: clamp(14px, 2.5vw, 16px);
            }
            .answer-btn, .submit-btn, #resetTrainerBtn {
                font-size: clamp(16px, 3vw, 18px);
                padding: 8px 15px;
                min-width: 100px;
            }
            .feedback {
                font-size: clamp(14px, 2.6vw, 16px);
            }
            .completion-message h2 {
                font-size: clamp(18px, 3vw, 20px);
            }
            .completion-message p {
                font-size: clamp(14px, 2.6vw, 16px);
            }
            .navigation-buttons {
                margin: 22px auto;
                gap: 16px;
            }
            .nav-button {
                font-size: 18px;
                padding: 8px 18px;
            }
            .trainer-question {
    font-size: clamp(16px, 2.8vw, 18px);
    }
    .submit-btn {
        font-size: clamp(16px, 3vw, 18px); /* Збільшуємо розмір шрифту */
        padding: 12px 24px; /* Збільшуємо відступи для більшої площі натискання */
        min-width: 120px; /* Збільшуємо мінімальну ширину */
        border-radius: 10px; /* Трохи більший радіус для кращого вигляду */
    }
                              }
        @media (max-width: 480px) {
            .title-box {
                margin-top: 20px;
                padding: 10px 15px;
            }
            .title-box h1 {
                font-size: 22px;
            }
            .section {
                width: 90%;
                height: 150px;
            }
            .section img {
                width: 50px;
                height: 50px;
            }
            .section h2 {
                font-size: 20px;
            }
            .modal-content {
                padding: 10px;
            }
            .video-card {
                width: 260px;
                height: 160px;
            }
            #theoryModal .modal-content p, #theoryModal .modal-content li {
                font-size: 16px !important;
            }
            #theoryModal mjx-container, #theoryModal .math-notation-centered {
                font-size: clamp(16px, 2.8vw, 18px) !important;
            }
            #trainerModal mjx-container, #questionsModal mjx-container {
                font-size: clamp(15px, 2.7vw, 17px) !important;
            }
            .question-card {
                height: 240px;
                max-width: 90%;
            }
            .card-front {
                font-size: clamp(15px, 2.8vw, 17px);
                padding: 8px 10px;
            }
            .card-back {
                padding: 8px 10px;
                font-size: clamp(15px, 2.8vw, 17px);
                justify-content: center;
                align-items: center;
                overflow-y: auto;
            }
            #questionsModal mjx-container {
                font-size: clamp(15px, 2.8vw, 17px) !important;
                max-width: 100%;
                margin: 5px auto;
                padding: 5px;
                overflow: visible !important;
            }
            #questionsModal mjx-container[jax="CHTML"][display="true"] {
                font-size: clamp(15px, 2.8vw, 17px) !important;
                max-width: 100%;
                margin: 5px auto;
                padding: 5px;
                overflow: visible !important;
                text-align: center;
            }
            .card-back p {
                font-size: clamp(15px, 2.8vw, 17px);
                margin: 5px 0;
                text-align: center;
            }
            .trainer-container {
                padding: 5vw 6vw;
                width: 95%;
                max-width: 700px;
            }
            .trainer-container p, .trainer-question {
                font-size: clamp(15px, 2.7vw, 17px);
            }
            .question-number {
                width: 70px;
                height: 70px;
                line-height: 70px;
                font-size: clamp(12px, 2.3vw, 14px);
            }
            .answer-btn, .submit-btn, #resetTrainerBtn {
                font-size: clamp(14px, 2.6vw, 16px);
                padding: 6px 12px;
                min-width: 80px;
            }
             #feedback {
        padding: 10px 15px;
        font-size: clamp(14px, 2.6vw, 16px);
        width: 80%;
        max-width: 300px;
        min-height: 60px; /* Менша висота для малих екранів */
    }
            .completion-message h2 {
                font-size: clamp(16px, 2.8vw, 18px);
            }
            .completion-message p {
                font-size: clamp(14px, 2.6vw, 16px);
            }
             .trainer-question {
    font-size: clamp(14px, 2.6vw, 16px);
    
}
              .nav-button {
                font-size: 16px;
                padding: 8px 16px;
            }
              .submit-btn {
        font-size: clamp(15px, 2.8vw, 17px); /* Трохи менший шрифт для дуже малих екранів */
        padding: 10px 20px; /* Збільшені відступи для зручності */
        min-width: 100px; /* Збільшена мінімальна ширина */
        border-radius: 8px; /* Зберігаємо стиль */
    }
             
        }
    </style>
</head>
<body>
    <div class="title-box">
        <h1>14. Визначник 3-го порядку</h1>
    </div>

    <div class="section-container">
        <div class="section" id="openTheoryBtn">
            <img src="https://img.icons8.com/fluency/96/book-shelf.png" alt="Книга">
            <h2>Теоретичні відомості</h2>
        </div>
        <div class="section" id="openVideoBtn">
            <img src="https://img.icons8.com/fluency/96/video.png" alt="Відео">
            <h2>Відеоматеріали</h2>
        </div>
        <div class="section" id="openQuestionsBtn">
            <img src="https://img.icons8.com/fluency/96/flipboard.png" alt="Картки">
            <h2>Питання і відповіді</h2>
        </div>
        <div class="section" id="openTrainerBtn">
            <img src="https://img.icons8.com/fluency/96/flash-on.png" alt="Тренажер">
            <h2>Тренажер</h2>
        </div>
    </div>

    <div class="navigation-buttons">
        <a class="nav-button" href='tema4.html'>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                <path d="M15 18l-6-6l6-6"/>
            </svg>
            До теми 4
        </a>
       <a class="nav-button" href='zmist.html'>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
  <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
</svg>
            До курсу
        </a>

    </div>

    <div id="modalOverlay"></div>

    <div id="theoryModal" class="modal">
        <div class="modal-header">
            <button class="close-btn" id="closeTheoryBtn">× Закрити</button>
        </div>
        <div class="modal-content">
            <details>
                <summary>Правило трикутників</summary>
                <p>Визначник третього порядку – це число, яке обчислюється для дев’яти чисел, розташованих у трьох рядках і трьох стовпцях. Він позначається так:</p>
                <p class="math-notation-centered">\(\Delta = \begin{vmatrix} a_{11} & a_{12} & a_{13} \\ a_{21} & a_{22} & a_{23} \\ a_{31} & a_{32} & a_{33} \end{vmatrix} \tag{4.3}\)</p>
                <p>Значення визначника (4.3) обчислюється за формулою:</p>
                <p class="math-notation-centered">\(\Delta = a_{11}a_{22}a_{33} + a_{12}a_{23}a_{31} + a_{13}a_{21}a_{32} - a_{13}a_{22}a_{31} - a_{12}a_{21}a_{33} - a_{11}a_{23}a_{32} \tag{4.4}\)</p>
                <p>Числа \(a_{11}, a_{12}, a_{13}, a_{21}, a_{22}, a_{23}, a_{31}, a_{32}, a_{33}\) називаються елементами визначника. Діагональ, утворена елементами \(a_{11}, a_{22}, a_{33}\), називається головною, а діагональ із елементів \(a_{13}, a_{22}, a_{31}\) – побічною.</p>
                <p>Щоб легше запам’ятати, які добутки у формулі (4.4) беруться зі знаком «+», а які зі знаком «-», використовують правило трикутників (рис. 4.2). Згідно з цим правилом, значення визначника можна обчислити, розглядаючи трикутники, утворені його елементами.</p>
                <img src="/static/figure4.2.jpg" alt="Схема правила трикутників" class="figure figure-4-2">
                <p>Пояснення до рис. 4.2. Значення визначника третього порядку – це сума добутків елементів головної діагоналі (\(a_{11}a_{22}a_{33}\)) та двох «трикутників» зі стороною, паралельною їй (\(a_{12}a_{23}a_{31}\) і \(a_{13}a_{21}a_{32}\)), від якої віднімається добуток елементів побічної діагоналі (\(a_{13}a_{22}a_{31}\)) та двох «трикутників» зі стороною, паралельною їй (\(a_{12}a_{21}a_{33}\) і \(a_{11}a_{23}a_{32}\)).</p>
                <p><span class="example-title">Приклад 4.3.</span> <span class="example-condition">Обчислити визначник \(\begin{vmatrix} 2 & 4 & 1 \\ -1 & 3 & 5 \\ 8 & -2 & 6 \end{vmatrix}\).</span></p>
                <p class="solution" style="text-align: center;"><strong>Розв’язання</strong></p>
                <p>Використовуючи правило трикутників, отримаємо:</p>
                <p class="math-notation-centered">\(\begin{vmatrix} 2 & 4 & 1 \\ -1 & 3 & 5 \\ 8 & -2 & 6 \end{vmatrix} = 2 \cdot 3 \cdot 6 + 4 \cdot 5 \cdot 8 + (-1) \cdot (-2) \cdot 1 - 1 \cdot 3 \cdot 8 - (-1) \cdot 4 \cdot 6 -\)</p>
<p>\(- (-2) \cdot 5 \cdot 2 = 36 + 160 + 2 - 24 + 24 + 20 = 218\)</p> <p><strong>Відповідь.</strong> \(\begin{vmatrix} 2 & 4 & 1 \\ -1 & 3 & 5 \\ 8 & -2 & 6 \end{vmatrix} = 218\)</p>
            </details>
            <details>
                <summary>Правило Саррюса</summary>
                <p>Цей метод, названий на честь французького математика П’єра Фредеріка Саррюса (1798–1861), полягає в дописуванні двох перших стовпців визначника з правого боку (або двох перших рядків знизу), утворюючи розширену схему. Наприклад, для визначника третього порядку, дописуємо перший і другий стовпці справа (або знизу дописуємо перший і другий рядки) (рис. 4.3).</p>
                <p>Цей підхід дозволяє побудувати три головні діагоналі і три допоміжні діагоналі, по яких легко обчислювати добутки елементів. Метод Саррюса дає такий самий результат, як і правило трикутників – це ще один спосіб обчислення визначника. Однак правило Саррюса застосовують лише до визначників третього порядку; методи для визначників вищого порядку будуть розглянуті згодом.</p>
                <p>За допомогою цього підходу виділяють три діагоналі, що йдуть зліва направо (пов’язані з головною діагоналлю), та три діагоналі, що йдуть справа наліво (пов’язані з побічною діагоналлю). Це дозволяє легко обчислювати добутки елементів.</p>
                <img src="/static/figure4.3.jpg" alt="Схема правила Саррюса" class="figure figure-4-3">
                <p>Пояснення до рис. 4.3. Щоб обчислити визначник, спочатку визначаємо головну діагональ, до якої будуть паралельні дві лінії. Перемножуємо елементи на цих лініях і додаємо їх, оскільки вони належать до головної діагоналі. Потім віднімаємо добутки елементів, пов’язаних з побічною діагоналлю та лініями, що паралельні їй.</p>
                <p><span class="example-title">Приклад 4.4.</span> <span class="example-condition">Обчислити визначник \(\begin{vmatrix} 2 & 4 & 1 \\ -1 & 3 & 5 \\ 8 & -2 & 6 \end{vmatrix}\).</span></p>
                <p class="solution" style="text-align: center;"><strong>Розв’язання</strong></p>
                <p>Для цього за правилом Саррюса допишемо перші два стовпці до правої частини визначника. Тоді запишемо добутки елементів по трьох головних діагоналях, паралельних між собою, які будемо додавати, а також добутки елементів по трьох допоміжних діагоналях, паралельних між собою, які будемо віднімати. Підсумуємо всі добутки:</p>
                <p class="math-notation-centered">\(\begin{vmatrix} 2 & 4 & 1 \\ -1 & 3 & 5 \\ 8 & -2 & 6 \end{vmatrix} \begin{matrix} 2 & 4 \\ -1 & 3 \\ 8 & -2 \end{matrix} = 2 \cdot 3 \cdot 6 + 4 \cdot 5 \cdot 8 + 1 \cdot (-1) \cdot (-2) - 1 \cdot 3 \cdot 8 - 2 \cdot 5 \cdot (-2) -\)</p>
<p>\(- 4 \cdot (-1) \cdot 6 = 36 + 160 + 2 - 24 + 20 + 24 = 218\)</p>
            <p><strong>Відповідь.</strong> \(\begin{vmatrix} 2 & 4 & 1 \\ -1 & 3 & 5 \\ 8 & -2 & 6 \end{vmatrix} = 218\)</p>
            </details>
        </div>
    </div>

    <div id="videoModal" class="modal">
        <div class="modal-header">
            <button class="close-btn" id="closeVideoBtn">× Закрити</button>
        </div>
        <div class="modal-content">
            <h2 class="glow-title">Оберіть відео</h2>
            <div class="video-card-container">
                <div class="video-card" data-video="1">
                    <img src="https://img.icons8.com/?size=100&id=o1CR3NjO7Pv8&format=png&color=000000" alt="Відеокамера">
                    <h3>Обчислення визначника 3-го порядку правилом трикутників</h3>
                </div>
                <div class="video-card" data-video="2">
                    <img src="https://img.icons8.com/?size=100&id=o1CR3NjO7Pv8&format=png&color=000000" alt="Відеокамера">
                    <h3>Evaluating a 3rd-order determinant with Sarrus’ Rule</h3>
                </div>
            </div>
        </div>
    </div>

    <div id="videoPlayerModal1" class="modal">
        <div class="modal-header">
            <button class="close-btn" id="closeVideoPlayerBtn1">× Закрити</button>
        </div>
        <div class="modal-content">
            <div class="video-player-container">
                <iframe id="youtubePlayer1" width="100%" src="https://www.youtube.com/embed/BarvTsQT0Po" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <div id="videoPlayerModal2" class="modal">
        <div class="modal-header">
            <button class="close-btn" id="closeVideoPlayerBtn2">× Закрити</button>
        </div>
        <div class="modal-content">
            <div class="video-player-container">
                <iframe id="youtubePlayer2" width="100%" src="https://www.youtube.com/embed/QAFU0Mxtjdk" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <div id="questionsModal" class="modal">
        <div class="modal-header">
            <button class="close-btn" id="closeQuestionsBtn">× Закрити</button>
        </div>
        <div class="modal-content">
            <div class="question-card">
                <div class="card-inner">
                    <div class="card-front">
                        1. Що називають визначником третього порядку?
                    </div>
                    <div class="card-back">
                        <p>Це число, яке обчислюється для дев’яти чисел, розташованих у трьох рядках і трьох стовпцях, за певною формулою.</p>
                    </div>
                </div>
            </div>
            <div class="question-card">
                <div class="card-inner">
                    <div class="card-front">
                        2. Як позначають визначник третього порядку?
                    </div>
                    <div class="card-back">
                        <p>Зазвичай його позначають як</p>
                        <p class="math-notation-centered">\[\Delta = \begin{vmatrix} a_{11} & a_{12} & a_{13} \\ a_{21} & a_{22} & a_{23} \\ a_{31} & a_{32} & a_{33} \end{vmatrix}\]</p>
                    </div>
                </div>
            </div>
            <div class="question-card">
                <div class="card-inner">
                    <div class="card-front">
                        3. Яка формула для обчислення визначника 3-го порядку?
                    </div>
                    <div class="card-back">
                        <p class="math-notation-centered">\[\Delta = a_{11}a_{22}a_{33} + a_{12}a_{23}a_{31} + a_{13}a_{21}a_{32} - a_{13}a_{22}a_{31} - a_{12}a_{21}a_{33} - a_{11}a_{23}a_{32}.\]</p>
                    </div>
                </div>
            </div>
            <div class="question-card">
                <div class="card-inner">
                    <div class="card-front">
                        4. Що таке правило трикутників?
                    </div>
                    <div class="card-back">
                        <p>Це спосіб обчислення визначника 3-го порядку, за яким від суми добутків елементів головної діагоналі та двох «трикутників» зі стороною, паралельною їй, віднімаються добутки елементів побічної діагоналі та двох «трикутників» зі стороною, паралельною їй.</p>
                    </div>
                </div>
            </div>
            <div class="question-card">
                <div class="card-inner">
                    <div class="card-front">
                        5. У чому полягає правило Саррюса?
                    </div>
                    <div class="card-back">
                        <p>У методі Саррюса перші два стовпці матриці (або два рядки) дописують справа (внизу), і обчислення проводять за шістьма діагоналями: трьома головними (додаються) і трьома побічними (віднімаються).</p>
                    </div>
                </div>
            </div>
            <div class="question-card">
                <div class="card-inner">
                    <div class="card-front">
                        6. Чи однаковий результат дають правило трикутників і Саррюса?
                    </div>
                    <div class="card-back">
                        <p>Так, обидва методи дають той самий результат при правильному обчисленні.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="trainerModal" class="modal">
        <div class="modal-header">
            <button class="close-btn" id="closeTrainerBtn">× Закрити</button>
        </div>
        <div class="modal-content">
            <div class="trainer-container" id="trainerContent">
                <div class="question-number" id="questionNumber">Питання 1</div>
                <p class="trainer-question" id="trainerQuestion"></p>
                <div id="matrixDisplay" class="math-notation-centered"></div>
                <div class="answer-buttons" id="answerButtons"></div>
                <button class="submit-btn" id="submitAnswerBtn" disabled>Відповісти</button>
                <p class="feedback" id="feedback"></p>
                <div id="completionScreen" style="display: none;">
                    <div class="completion-emoji"></div>
                    <div class="completion-message">
                       <h2>МІСІЯ ВИКОНАНА!</h2>
     <p>Визначники 3-го порядку підкорено!</p>
    <p><strong>СЛАВА УКРАЇНІ!</strong></p>
    <button id="resetTrainerBtn">Повернутися на полігон!</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
const modals = {
    theory: document.getElementById('theoryModal'),
    video: document.getElementById('videoModal'),
    questions: document.getElementById('questionsModal'),
    trainer: document.getElementById('trainerModal'),
    videoPlayer1: document.getElementById('videoPlayerModal1'),
    videoPlayer2: document.getElementById('videoPlayerModal2')
};

const buttons = {
    openTheory: document.getElementById('openTheoryBtn'),
    openVideo: document.getElementById('openVideoBtn'),
    openQuestions: document.getElementById('openQuestionsBtn'),
    openTrainer: document.getElementById('openTrainerBtn'),
    closeTheory: document.getElementById('closeTheoryBtn'),
    closeVideo: document.getElementById('closeVideoBtn'),
    closeQuestions: document.getElementById('closeQuestionsBtn'),
    closeTrainer: document.getElementById('closeTrainerBtn'),
    closeVideoPlayer1: document.getElementById('closeVideoPlayerBtn1'),
    closeVideoPlayer2: document.getElementById('closeVideoPlayerBtn2'),
    submitAnswer: document.getElementById('submitAnswerBtn')
};

const overlay = document.getElementById('modalOverlay');

const youtubePlayers = {
    1: document.getElementById('youtubePlayer1'),
    2: document.getElementById('youtubePlayer2')
};

let scrollPosition = 0;

const trainerContent = document.getElementById('trainerContent');
const questionNumber = document.getElementById('questionNumber');
const trainerQuestion = document.getElementById('trainerQuestion');
const matrixDisplay = document.getElementById('matrixDisplay');
const answerButtons = document.getElementById('answerButtons');
const feedback = document.getElementById('feedback');
const completionScreen = document.getElementById('completionScreen');
const resetTrainerBtn = document.getElementById('resetTrainerBtn');
const submitAnswerBtn = document.getElementById('submitAnswerBtn');

let currentQuestion = 1;
let selectedAnswer = null;

function typesetMath(context = 'general', elements = null) {
    if (window.mathJaxReady && typeof MathJax !== 'undefined' && typeof MathJax.typesetPromise === 'function') {
        console.log(`Starting MathJax typeset for ${context}`);
        MathJax.typesetClear(elements || undefined);
        MathJax.typesetPromise(elements || undefined).then(() => {
            console.log(`MathJax typeset complete for ${context}`);
            if (elements && elements.includes(matrixDisplay)) {
                matrixDisplay.classList.add('mathjax-rendered');
                if (context === 'trainer question 4' || context === 'trainer question 5') {
                    const mjxContainer = matrixDisplay.querySelector('mjx-container');
                    if (mjxContainer) {
                        const matrixElement = mjxContainer.querySelector('mjx-mtable');
                        if (matrixElement) {
                            matrixElement.classList.add('yellow-matrix');
                        }
                        setTimeout(() => {
                            console.log(`Forcing MathJax re-render for ${context}`);
                            MathJax.typesetClear([matrixDisplay]);
                            MathJax.typesetPromise([matrixDisplay]).then(() => {
                                console.log(`MathJax re-render complete for ${context}`);
                                const newMatrixElement = matrixDisplay.querySelector('mjx-container mjx-mtable');
                                if (newMatrixElement) {
                                    newMatrixElement.classList.add('yellow-matrix');
                                } else {
                                    console.warn(`No mjx-mtable found after re-render in ${context}`);
                                }
                            }).catch(err => console.error(`MathJax re-render error in ${context}:`, err));
                        }, 200);
                    } else {
                        console.warn(`No mjx-container found for yellow-matrix in ${context}`);
                    }
                }
            }
        }).catch(err => {
            console.error(`MathJax typesetting error in ${context}:`, err);
            feedback.textContent = 'Помилка рендерингу формули. Спробуйте ще раз!';
            feedback.className = 'feedback incorrect';
        });
    } else {
        console.warn(`MathJax not ready or typesetPromise unavailable in ${context}`);
        feedback.textContent = 'MathJax не завантажено. Спробуйте оновити сторінку!';
        feedback.className = 'feedback incorrect';
    }
}


function waitForMathJax(callback, context = 'general', maxAttempts = 50, interval = 100) {
    let attempts = 0;
    console.log(`Waiting for MathJax in ${context}`);
    const checkMathJax = setInterval(() => {
        if (window.mathJaxReady && typeof MathJax !== 'undefined' && typeof MathJax.typesetPromise === 'function') {
            clearInterval(checkMathJax);
            console.log(`MathJax ready for ${context}, executing callback`);
            callback();
        } else if (attempts >= maxAttempts) {
            clearInterval(checkMathJax);
            console.warn(`MathJax not loaded after ${maxAttempts * interval}ms in ${context}`);
            feedback.textContent = 'MathJax не завантажено. Спробуйте оновити сторінку!';
            feedback.className = 'feedback incorrect';
        }
        attempts++;
    }, interval);
}

function getRandomInt(min = -5, max = 5) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function formatProduct(indices, matrix, useIndices = false, plainText = false) {
    const [i1, i2, i3] = indices;
    if (useIndices) {
        return `\\(a_{${i1[0] + 1}${i1[1] + 1}} \\cdot a_{${i2[0] + 1}${i2[1] + 1}} \\cdot a_{${i3[0] + 1}${i3[1] + 1}}\\)`;
    } else {
        const a = matrix[i1[0]][i1[1]];
        const b = matrix[i2[0]][i2[1]];
        const c = matrix[i3[0]][i3[1]];
        const aFormatted = a < 0 ? `(${a})` : `${a}`;
        const bFormatted = b < 0 ? `(${b})` : `${b}`;
        const cFormatted = typeof c === 'string' ? c : (c < 0 ? `(${c})` : `${c}`);
        if (plainText) {
            return `${aFormatted} · ${bFormatted} · ${cFormatted}`;
        }
        return `\\(${aFormatted} \\cdot ${bFormatted} \\cdot ${cFormatted}\\)`;
    }
}

function calculateDeterminant(matrix) {
    const [[a, b, c], [d, e, f], [g, h, i]] = matrix;
    return a * e * i + b * f * g + c * d * h - c * e * g - b * d * i - a * f * h;
}

function generateQuestion1() {
    try {
        const matrix = [
            [getRandomInt(), getRandomInt(), getRandomInt()],
            [getRandomInt(), getRandomInt(), getRandomInt()],
            [getRandomInt(), getRandomInt(), getRandomInt()]
        ];
        const validProducts = [
            { indices: [[0,0], [1,1], [2,2]], sign: '+' },
            { indices: [[0,1], [1,2], [2,0]], sign: '+' },
            { indices: [[0,2], [1,0], [2,1]], sign: '+' },
            { indices: [[0,2], [1,1], [2,0]], sign: '-' },
            { indices: [[0,1], [1,0], [2,2]], sign: '-' },
            { indices: [[0,0], [1,2], [2,1]], sign: '-' }
        ];
        const incorrectProducts = [
            { indices: [[0,0], [1,1], [2,0]], sign: 'x' },
            { indices: [[0,1], [1,1], [2,1]], sign: 'x' },
            { indices: [[0,2], [1,2], [2,2]], sign: 'x' },
            { indices: [[0,0], [1,0], [2,0]], sign: 'x' },
            { indices: [[0,1], [1,0], [2,1]], sign: 'x' }
        ];
        const incorrectProduct = incorrectProducts[Math.floor(Math.random() * incorrectProducts.length)];
        const selectedValid = shuffleArray([...validProducts]).slice(0, 3);
        const allOptions = [
            { text: formatProduct(incorrectProduct.indices, matrix, false, true), correct: true },
            ...selectedValid.map(prod => ({ text: formatProduct(prod.indices, matrix, false, true), correct: false }))
        ];
        const shuffledOptions = shuffleArray(allOptions);
        console.log('Shuffled options:', shuffledOptions.map(opt => ({ text: opt.text, correct: opt.correct })));
        const matrixLatex = `\\begin{vmatrix} ${matrix[0].join(' & ')} \\\\ ${matrix[1].join(' & ')} \\\\ ${matrix[2].join(' & ')} \\end{vmatrix}`;
        console.log('Generating Question 1');
        questionNumber.textContent = 'Питання 1';
        trainerQuestion.textContent = 'Який з наведених нижче добутків не входить у визначник за правилом трикутників?';
        matrixDisplay.classList.remove('mathjax-rendered');
        matrixDisplay.innerHTML = '';
        if (window.MathJax) {
            MathJax.typesetClear([matrixDisplay]);
            console.log('Cleared MathJax state for Question 1');
        }
        matrixDisplay.innerHTML = `<div style="display: block;" id="matrix-${Date.now()}">\\[${matrixLatex}\\]</div>`;
        answerButtons.innerHTML = '';
        shuffledOptions.forEach((option, index) => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn';
            btn.textContent = option.text;
            btn.dataset.correct = option.correct;
            btn.addEventListener('click', () => selectAnswer(btn));
            answerButtons.appendChild(btn);
        });
        submitAnswerBtn.disabled = true;
        selectedAnswer = null;
        feedback.textContent = '';
        console.log('DOM updated for Question 1, scheduling MathJax');
        setTimeout(() => {
            waitForMathJax(() => {
                console.log('Triggering MathJax for Question 1');
                typesetMath('trainer question 1', [matrixDisplay]);
            }, 'trainer question 1');
        }, 100);
    } catch (err) {
        console.error('Error in generateQuestion1:', err);
        feedback.textContent = 'Помилка генерації питання. Спробуйте ще раз!';
        feedback.className = 'feedback incorrect';
    }
}

function generateQuestion2() {
    try {
        const matrix = [
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)],
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)],
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)]
        ];
        const validProducts = [
            { indices: [[0,0], [1,1], [2,2]], sign: ' + ' },
            { indices: [[0,1], [1,2], [2,0]], sign: ' + ' },
            { indices: [[0,2], [1,0], [2,1]], sign: ' + ' },
            { indices: [[0,2], [1,1], [2,0]], sign: ' ─ ' },
            { indices: [[0,1], [1,0], [2,2]], sign: ' ─ ' },
            { indices: [[0,0], [1,2], [2,1]], sign: ' ─ ' }
        ];
        const selectedProducts = shuffleArray([...validProducts]).slice(0, 2);
        const product1 = selectedProducts[0];
        const product2 = selectedProducts[1];
        const answerOptions = [
            { text: `«${product1.sign}» і «${product2.sign}»`, correct: true },
            { text: `«${product1.sign === ' + ' ? ' ─ ' : ' + '}» і «${product2.sign}»`, correct: false },
            { text: `«${product1.sign}» і «${product2.sign === ' + ' ? ' ─ ' : ' + '}»`, correct: false },
            { text: `«${product1.sign === ' + ' ? ' ─ ' : ' + '}» і «${product2.sign === ' + ' ? ' ─ ' : ' + '}»`, correct: false }
        ];
        const shuffledOptions = shuffleArray(answerOptions);
        const matrixLatex = `\\begin{vmatrix} ${matrix[0].join(' & ')} \\\\ ${matrix[1].join(' & ')} \\\\ ${matrix[2].join(' & ')} \\end{vmatrix}`;
        const questionText = `У визначнику \\[${matrixLatex}\\] добутки ${formatProduct(product1.indices, matrix, false)} і ${formatProduct(product2.indices, matrix, false)} входять із знаками відповідно`;
        console.log('Generating Question 2');
        questionNumber.textContent = 'Питання 2';
        trainerQuestion.innerHTML = questionText;
        matrixDisplay.classList.remove('mathjax-rendered');
        matrixDisplay.innerHTML = '';
        answerButtons.innerHTML = '';
        shuffledOptions.forEach((option, index) => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn';
            btn.textContent = option.text;
            btn.dataset.correct = option.correct;
            btn.addEventListener('click', () => selectAnswer(btn));
            answerButtons.appendChild(btn);
        });
        submitAnswerBtn.disabled = true;
        selectedAnswer = null;
        feedback.textContent = '';
        console.log('DOM updated for Question 2, scheduling MathJax');
        waitForMathJax(() => {
            console.log('Triggering MathJax for Question 2');
            typesetMath('trainer question 2', [trainerQuestion]);
        }, 'trainer question 2');
    } catch (err) {
        console.error('Error in generateQuestion2:', err);
        feedback.textContent = 'Помилка генерації питання. Спробуйте ще раз!';
        feedback.className = 'feedback incorrect';
    }
}

function generateQuestion3() {
    try {
        const matrix = [
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)],
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)],
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)]
        ];
        const correctDet = calculateDeterminant(matrix);
        let incorrectAnswers = new Set();
        let attempts = 0;
        const maxAttempts = 100;
        while (incorrectAnswers.size < 3 && attempts < maxAttempts) {
            let wrong = correctDet + getRandomInt(-20, 20) * 5;
            if (wrong !== correctDet && !incorrectAnswers.has(wrong)) {
                incorrectAnswers.add(wrong);
            }
            attempts++;
        }
        if (incorrectAnswers.size < 3) {
            console.warn('Не вдалося згенерувати достатньо унікальних неправильних відповідей');
            incorrectAnswers = Array.from(incorrectAnswers);
            while (incorrectAnswers.length < 3) {
                incorrectAnswers.push(correctDet + (incorrectAnswers.length + 1) * 50);
            }
        } else {
            incorrectAnswers = Array.from(incorrectAnswers);
        }
        const answerOptions = [
            { text: `${correctDet}`, correct: true },
            { text: `${incorrectAnswers[0]}`, correct: false },
            { text: `${incorrectAnswers[1]}`, correct: false },
            { text: `${incorrectAnswers[2]}`, correct: false }
        ];
        console.log('Generating Question 3');
        console.log('Generated matrix:', matrix);
        console.log('Correct determinant:', correctDet);
        console.log('Answer options:', answerOptions);
        console.log('LaTeX for matrix:', `\\begin{vmatrix} ${matrix[0].join(' & ')} \\\\ ${matrix[1].join(' & ')} \\\\ ${matrix[2].join(' & ')} \\end{vmatrix}`);
        const shuffledOptions = shuffleArray(answerOptions);
        const matrixLatex = `\\begin{vmatrix} ${matrix[0].join(' & ')} \\\\ ${matrix[1].join(' & ')} \\\\ ${matrix[2].join(' & ')} \\end{vmatrix}`;
        questionNumber.textContent = 'Питання 3';
        trainerQuestion.textContent = 'Обчислити визначник:';
        matrixDisplay.classList.remove('mathjax-rendered');
        matrixDisplay.innerHTML = '';
        if (window.MathJax) {
            MathJax.typesetClear([matrixDisplay, answerButtons]);
            console.log('Cleared MathJax state for Question 3');
        }
        matrixDisplay.innerHTML = `<div style="display: block;" id="matrix-${Date.now()}">\\[${matrixLatex}\\]</div>`;
        answerButtons.innerHTML = '';
        shuffledOptions.forEach((option, index) => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn';
            btn.textContent = option.text;
            btn.dataset.correct = option.correct;
            btn.addEventListener('click', () => selectAnswer(btn));
            answerButtons.appendChild(btn);
        });
        submitAnswerBtn.disabled = true;
        selectedAnswer = null;
        feedback.textContent = '';
        console.log('DOM updated for Question 3, scheduling MathJax');
        waitForMathJax(() => {
            console.log('Triggering MathJax for Question 3');
            typesetMath('trainer question 3', [matrixDisplay, answerButtons]);
        }, 'trainer question 3');
    } catch (err) {
        console.error('Error in generateQuestion3:', err);
        feedback.textContent = 'Помилка генерації питання 3. Спробуйте ще раз!';
        feedback.className = 'feedback incorrect';
    }
}

function generateQuestion4() {
    try {
        const x = getRandomInt(-10, 10);
        const matrix = [
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)],
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)],
            [getRandomInt(-5, 5), getRandomInt(-5, 5), x]
        ];
        const [[a, b, c], [d, e, f], [g, h, _]] = matrix;
        const k = a * (e * x - f * h) + b * (f * g - d * x) + c * (d * h - e * g);
        let incorrectAnswers = new Set();
        let attempts = 0;
        const maxAttempts = 100;
        while (incorrectAnswers.size < 3 && attempts < maxAttempts) {
            let wrong = x + getRandomInt(-10, 10);
            if (wrong !== x && !incorrectAnswers.has(wrong) && wrong >= -20 && wrong <= 20) {
                incorrectAnswers.add(wrong);
            }
            attempts++;
        }
        if (incorrectAnswers.size < 3) {
            console.warn('Не вдалося згенерувати достатньо унікальних неправильних відповідей');
            incorrectAnswers = Array.from(incorrectAnswers);
            while (incorrectAnswers.length < 3) {
                incorrectAnswers.push(x + (incorrectAnswers.length + 1) * 10);
            }
        } else {
            incorrectAnswers = Array.from(incorrectAnswers);
        }
        const answerOptions = [
            { text: `${x}`, correct: true },
            { text: `${incorrectAnswers[0]}`, correct: false },
            { text: `${incorrectAnswers[1]}`, correct: false },
            { text: `${incorrectAnswers[2]}`, correct: false }
        ];
        const shuffledOptions = shuffleArray(answerOptions);
        matrix[2][2] = 'x';
        const matrixLatex = `\\begin{vmatrix} ${matrix[0].join(' & ')} \\\\ ${matrix[1].join(' & ')} \\\\ ${matrix[2].join(' & ')} \\end{vmatrix} = ${k}`;
        console.log('Generating Question 4');
        console.log('Generated matrix:', matrix);
        console.log('Determinant value k:', k);
        console.log('Correct x:', x);
        console.log('Answer options:', answerOptions);
        console.log('LaTeX for equation:', matrixLatex);
        questionNumber.textContent = 'Питання 4';
        trainerQuestion.textContent = 'Знайти x, якщо';
        matrixDisplay.classList.remove('mathjax-rendered');
        matrixDisplay.innerHTML = '';
        if (window.MathJax) {
            MathJax.typesetClear([matrixDisplay, answerButtons]);
            console.log('Cleared MathJax state for Question 4');
        }
        matrixDisplay.innerHTML = `<div style="display: block;" id="matrix-${Date.now()}">\\[${matrixLatex}\\]</div>`;
        answerButtons.innerHTML = '';
        shuffledOptions.forEach((option, index) => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn';
            btn.textContent = option.text;
            btn.dataset.correct = option.correct;
            btn.addEventListener('click', () => selectAnswer(btn));
            answerButtons.appendChild(btn);
        });
        submitAnswerBtn.disabled = true;
        selectedAnswer = null;
        feedback.textContent = '';
        console.log('DOM updated for Question 4, scheduling MathJax');
        waitForMathJax(() => {
            console.log('Triggering MathJax for Question 4');
            typesetMath('trainer question 4', [matrixDisplay, answerButtons]);
        }, 'trainer question 4');
    } catch (err) {
        console.error('Error in generateQuestion4:', err);
        feedback.textContent = 'Помилка генерації питання 4. Спробуйте ще раз!';
        feedback.className = 'feedback incorrect';
    }
}

function generateQuestion5() {
    try {
        const x = getRandomInt(-10, 10);
        const rightMatrix = [
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)],
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)],
            [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)]
        ];
        const k = calculateDeterminant(rightMatrix);
        let xCoeff = 0;
        let leftMatrix;
        let attempts = 0;
        const maxAttempts = 50;
        while (xCoeff === 0 && attempts < maxAttempts) {
            leftMatrix = [
                [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)],
                [getRandomInt(-5, 5), getRandomInt(-5, 5), getRandomInt(-5, 5)],
                [getRandomInt(-5, 5), getRandomInt(-5, 5), x]
            ];
            const [[a, b, c], [d, e, f], [g, h, _]] = leftMatrix;
            xCoeff = a * e - b * d;
            attempts++;
        }
        if (xCoeff === 0) {
            console.warn('Could not generate non-zero xCoeff after max attempts');
            return generateQuestion5();
        }
        const [[a, b, c], [d, e, f], [g, h, _]] = leftMatrix;
        const constant = a * (-f * h) + b * f * g + c * d * h - c * e * g;
        const gCoeff = c * e - a * e;
        if (gCoeff === 0) {
            console.log('gCoeff is zero, regenerating');
            return generateQuestion5();
        }
        const newG = (k - xCoeff * x - constant) / gCoeff;
        if (!Number.isInteger(newG) || newG < -5 || newG > 5) {
            console.log('newG not integer or out of range:', newG);
            return generateQuestion5();
        }
        leftMatrix[2][0] = newG;
        leftMatrix[2][2] = x;
        const leftDet = calculateDeterminant(leftMatrix);
        if (leftDet !== k) {
            console.warn('Determinants do not match:', leftDet, k, 'Regenerating');
            return generateQuestion5();
        }
        let incorrectAnswers = new Set();
        attempts = 0;
        while (incorrectAnswers.size < 3 && attempts < maxAttempts) {
            let wrong = x + getRandomInt(-10, 10);
            if (wrong !== x && !incorrectAnswers.has(wrong) && wrong >= -20 && wrong <= 20) {
                incorrectAnswers.add(wrong);
            }
            attempts++;
        }
        if (incorrectAnswers.size < 3) {
            console.warn('Не вдалося згенерувати достатньо унікальних неправильних відповідей');
            incorrectAnswers = Array.from(incorrectAnswers);
            while (incorrectAnswers.length < 3) {
                incorrectAnswers.push(x + (incorrectAnswers.length + 1) * 10);
            }
        } else {
            incorrectAnswers = Array.from(incorrectAnswers);
        }
        const answerOptions = [
            { text: `${x}`, correct: true },
            { text: `${incorrectAnswers[0]}`, correct: false },
            { text: `${incorrectAnswers[1]}`, correct: false },
            { text: `${incorrectAnswers[2]}`, correct: false }
        ];
        const shuffledOptions = shuffleArray(answerOptions);
        leftMatrix[2][2] = 'x';
        const leftMatrixLatex = `\\begin{vmatrix} ${leftMatrix[0].join(' & ')} \\\\ ${leftMatrix[1].join(' & ')} \\\\ ${leftMatrix[2].join(' & ')} \\end{vmatrix}`;
        const rightMatrixLatex = `\\begin{vmatrix} ${rightMatrix[0].join(' & ')} \\\\ ${rightMatrix[1].join(' & ')} \\\\ ${rightMatrix[2].join(' & ')} \\end{vmatrix}`;
        const equationLatex = `${leftMatrixLatex} = ${rightMatrixLatex}`;
        console.log('Generating Question 5');
        console.log('Left matrix:', leftMatrix);
        console.log('Right matrix:', rightMatrix);
        console.log('Right determinant k:', k);
        console.log('Left determinant:', leftDet);
        console.log('Correct x:', x);
        console.log('xCoeff:', xCoeff, 'gCoeff:', gCoeff, 'newG:', newG);
        console.log('Answer options:', answerOptions);
        console.log('LaTeX for equation:', equationLatex);
        questionNumber.textContent = 'Питання 5';
        trainerQuestion.textContent = 'Знайти x, якщо';
        matrixDisplay.classList.remove('mathjax-rendered');
        matrixDisplay.innerHTML = '';
        if (window.MathJax) {
            MathJax.typesetClear([matrixDisplay, answerButtons]);
            console.log('Cleared MathJax state for Question 5');
        }
        matrixDisplay.innerHTML = `<div style="display: block;" id="matrix-${Date.now()}">\\[${equationLatex}\\]</div>`;
        answerButtons.innerHTML = '';
        shuffledOptions.forEach((option, index) => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn';
            btn.textContent = option.text;
            btn.dataset.correct = option.correct;
            btn.addEventListener('click', () => selectAnswer(btn));
            answerButtons.appendChild(btn);
        });
        submitAnswerBtn.disabled = true;
        selectedAnswer = null;
        feedback.textContent = '';
        console.log('DOM updated for Question 5, scheduling MathJax');
        waitForMathJax(() => {
            console.log('Triggering MathJax for Question 5');
            typesetMath('trainer question 5', [matrixDisplay, answerButtons]);
        }, 'trainer question 5');
    } catch (err) {
        console.error('Error in generateQuestion5:', err);
        feedback.textContent = 'Помилка генерації питання 5. Спробуйте ще раз!';
        feedback.className = 'feedback incorrect';
    }
}

function selectAnswer(btn) {
    console.log('Selected button:', btn, 'Correct:', btn.dataset.correct);
    document.querySelectorAll('.answer-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedAnswer = btn;
    submitAnswerBtn.disabled = false;
}

function handleSubmit() {
    console.log('Submit clicked, selectedAnswer:', selectedAnswer, 'currentQuestion:', currentQuestion);
    if (!selectedAnswer) {
        console.warn('No answer selected');
        feedback.textContent = 'Виберіть відповідь!';
        feedback.className = 'feedback incorrect';
        feedback.classList.add('show');
        return;
    }
    try {
        const isCorrect = selectedAnswer.dataset.correct === 'true';
        document.querySelectorAll('.answer-btn').forEach(b => b.disabled = true);
        submitAnswerBtn.disabled = true;
        feedback.classList.remove('show', 'correct', 'incorrect');
        if (isCorrect) {
            feedback.textContent = '✅ ВІРНО! Ціль уражена!';
            feedback.className = 'feedback correct';
            feedback.classList.add('show');
            console.log('Correct answer, incrementing currentQuestion from', currentQuestion);
            setTimeout(() => {
                console.log('Before increment, currentQuestion:', currentQuestion);
                currentQuestion++;
                console.log('After increment, new currentQuestion:', currentQuestion);
                feedback.classList.remove('show', 'correct', 'incorrect');
                feedback.textContent = '';
                if (currentQuestion > 5) {
                    console.log('Showing completion screen');
                    showCompletionScreen();
                } else if (currentQuestion === 2) {
                    console.log('Generating Question 2');
                    generateQuestion2();
                } else if (currentQuestion === 3) {
                    console.log('Generating Question 3');
                    generateQuestion3();
                } else if (currentQuestion === 4) {
                    console.log('Generating Question 4');
                    generateQuestion4();
                } else if (currentQuestion === 5) {
                    console.log('Generating Question 5');
                    generateQuestion5();
                } else {
                    console.error('Unexpected currentQuestion value:', currentQuestion);
                    feedback.textContent = 'Помилка переходу до наступного питання!';
                    feedback.className = 'feedback incorrect';
                    feedback.classList.add('show');
                }
            }, 1000);
        } else {
            feedback.textContent = '❌ Промах! Спробуй ще!';
            feedback.className = 'feedback incorrect';
            feedback.classList.add('show');
            setTimeout(() => {
                console.log('Incorrect answer, regenerating current question:', currentQuestion);
                feedback.classList.remove('show', 'correct', 'incorrect');
                feedback.textContent = '';
                if (currentQuestion === 1) {
                    generateQuestion1();
                } else if (currentQuestion === 2) {
                    generateQuestion2();
                } else if (currentQuestion === 3) {
                    generateQuestion3();
                } else if (currentQuestion === 4) {
                    generateQuestion4();
                } else if (currentQuestion === 5) {
                    generateQuestion5();
                }
                document.querySelectorAll('.answer-btn').forEach(b => b.disabled = false);
                submitAnswerBtn.disabled = true;
                selectedAnswer = null;
            }, 1000);
        }
    } catch (err) {
        console.error('Error in handleSubmit:', err);
        feedback.textContent = 'Виникла помилка, спробуйте ще раз!';
        feedback.className = 'feedback incorrect';
        feedback.classList.add('show');
    }
}

function showCompletionScreen() {
    console.log('showCompletionScreen called');
    questionNumber.style.display = 'none';
    trainerQuestion.style.display = 'none';
    matrixDisplay.style.display = 'none';
    answerButtons.style.display = 'none';
    submitAnswerBtn.style.display = 'none';
    feedback.style.display = 'none';
    completionScreen.style.display = 'block';
    matrixDisplay.classList.remove('mathjax-rendered');
    waitForMathJax(() => typesetMath('completion screen'), 'completion screen');
}

function resetTrainer() {
    console.log('resetTrainer called');
    currentQuestion = 1;
    questionNumber.style.display = 'block';
    trainerQuestion.style.display = 'block';
    matrixDisplay.style.display = 'block';
    answerButtons.style.display = 'flex';
    submitAnswerBtn.style.display = 'block';
    feedback.style.display = 'block';
    completionScreen.style.display = 'none';
    feedback.textContent = '';
    matrixDisplay.classList.remove('mathjax-rendered');
    generateQuestion1();
}

function openModal(modal, btn) {
    try {
        if (!modal || !btn) {
            console.error('Modal or button is null:', { modal, btn });
            return;
        }
        console.log('Opening modal:', modal.id);
        scrollPosition = window.scrollY;
        modal.style.display = 'flex';
        modal.classList.add('show');
        overlay.style.display = 'block';
        overlay.style.opacity = '1';
        document.body.classList.add('modal-open');
        document.body.style.top = `-${scrollPosition}px`;
        btn.setAttribute('aria-pressed', 'true');
        waitForMathJax(() => {
            typesetMath('modal open', [modal]);
            if (modal === modals.trainer && currentQuestion === 1) {
                console.log('Initializing trainer with Question 1');
                generateQuestion1();
            }
        }, 'modal open');
    } catch (err) {
        console.error('Error opening modal:', err);
    }
}

function closeModal(modal, btn) {
    try {
        if (!modal || !btn) {
            console.error('Modal or button is null:', { modal, btn });
            return;
        }
        console.log('Closing modal:', modal.id);
        modal.style.display = 'none';
        modal.classList.remove('show');
        overlay.style.display = 'none';
        overlay.style.opacity = '0';
        document.body.classList.remove('modal-open');
        document.body.style.top = '';
        window.scrollTo(0, scrollPosition);
        btn.setAttribute('aria-pressed', 'false');
        btn.focus();
        if (modal === modals.questions) {
            const cards = modal.querySelectorAll('.card-inner');
            cards.forEach(card => card.classList.remove('flipped'));
        }
        if (modal === modals.trainer) {
            resetTrainer();
        }
    } catch (err) {
        console.error('Error closing modal:', err);
    }
}

function closeVideoPlayerModal(videoModal, player, mainModal, btn) {
    try {
        if (player) {
            const src = player.getAttribute('data-src') || player.src;
            player.src = '';
            player.src = src;
        }
        if (videoModal) {
            videoModal.style.display = 'none';
            videoModal.classList.remove('show');
        }
        openModal(mainModal, btn);
    } catch (err) {
        console.error('Error closing video player modal:', err);
    }
}

if (buttons.openTheory) buttons.openTheory.addEventListener('click', () => openModal(modals.theory, buttons.openTheory));
if (buttons.openVideo) buttons.openVideo.addEventListener('click', () => openModal(modals.video, buttons.openVideo));
if (buttons.openQuestions) buttons.openQuestions.addEventListener('click', () => openModal(modals.questions, buttons.openQuestions));
if (buttons.openTrainer) buttons.openTrainer.addEventListener('click', () => openModal(modals.trainer, buttons.openTrainer));
if (buttons.closeTheory) buttons.closeTheory.addEventListener('click', () => closeModal(modals.theory, buttons.openTheory));
if (buttons.closeVideo) buttons.closeVideo.addEventListener('click', () => closeModal(modals.video, buttons.openVideo));
if (buttons.closeQuestions) buttons.closeQuestions.addEventListener('click', () => closeModal(modals.questions, buttons.openQuestions));
if (buttons.closeTrainer) buttons.closeTrainer.addEventListener('click', () => closeModal(modals.trainer, buttons.openTrainer));
if (buttons.closeVideoPlayer1) buttons.closeVideoPlayer1.addEventListener('click', () => closeVideoPlayerModal(modals.videoPlayer1, youtubePlayers[1], modals.video, buttons.openVideo));
if (buttons.closeVideoPlayer2) buttons.closeVideoPlayer2.addEventListener('click', () => closeVideoPlayerModal(modals.videoPlayer2, youtubePlayers[2], modals.video, buttons.openVideo));

if (overlay) {
    overlay.addEventListener('click', () => {
        Object.values(modals).forEach(modal => {
            console.log('Overlay clicked, closing modal:', modal.id);
            modal.classList.remove('show');
            overlay.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                overlay.style.display = 'none';
                document.body.classList.remove('modal-open');
                document.body.style.top = '';
                window.scrollTo(0, scrollPosition);
                Object.values(youtubePlayers).forEach(player => {
                    if (player) {
                        const src = player.getAttribute('data-src') || player.src;
                        player.src = '';
                        player.src = src;
                    }
                });
                if (modal === modals.questions) {
                    const cards = modal.querySelectorAll('.card-inner');
                    cards.forEach(card => card.classList.remove('flipped'));
                }
                if (modal === modals.trainer) {
                    resetTrainer();
                }
            }, 250);
        });
    });
}

document.querySelectorAll('.video-card').forEach(card => {
    card.addEventListener('click', () => {
        const videoId = card.dataset.video;
        console.log('Video card clicked, opening video player:', videoId);
        openModal(modals[`videoPlayer${videoId}`], buttons.openVideo);
    });
});

document.querySelectorAll('.card-inner').forEach(card => {
    card.addEventListener('click', () => {
        console.log('Card clicked, flipping:', card);
        card.classList.toggle('flipped');
        if (card.classList.contains('flipped')) {
            waitForMathJax(() => {
                typesetMath('card flip', [card]);
            }, 'card flip');
        }
    });
});

if (resetTrainerBtn) {
    resetTrainerBtn.addEventListener('click', resetTrainer);
}

if (submitAnswerBtn) {
    submitAnswerBtn.addEventListener('click', handleSubmit);
}

Object.values(youtubePlayers).forEach(player => {
    if (player) {
        player.setAttribute('data-src', player.src);
    }
});

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM fully loaded');
    console.log('openTrainerBtn:', buttons.openTrainer);
    console.log('trainerModal:', modals.trainer);
    const detailsElements = document.querySelectorAll('details');
    detailsElements.forEach(details => {
        details.addEventListener('toggle', () => {
            if (modals.theory && modals.theory.style.display === 'flex') {
                waitForMathJax(() => typesetMath('details toggle', [modals.theory]), 'details toggle');
            }
        });
    });
    waitForMathJax(() => typesetMath('initial load'), 'initial load');
});
    </script>
</body>
</html>



