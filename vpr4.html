<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–≤–¥–∞–Ω–Ω—è 4</title>
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f0f0f0;
            margin: 16px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        body.loaded {
            visibility: visible;
            opacity: 1;
        }
        .complex-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }
        .icon {
            font-size: 28px;
            color: #0000ff;
            animation: pulse 1.5s infinite;
        }
        .label-text {
            font-size: 20px;
            font-weight: 700;
            color: #1e3a8a;
        }
        .complex-number {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, #6dd5ed, #2193b0);
            border-radius: 8px;
            color: #ffff00;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .complex-number.rendered {
            opacity: 1;
        }
        canvas {
            background: #ffffff;
            margin-top: 10px;
            outline: none;
        }
        .controls {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 6px;
            background-color: #008080;
            color: white;
            border: none;
        }
        button:hover:not(:disabled) {
            background-color: #006666;
        }
        button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        .close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: #ffffff;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, background 0.2s;
        }
        .close-btn:hover {
            background: linear-gradient(135deg, #cc0000, #ff4444);
            transform: scale(1.1);
        }
        #feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px;
            border-radius: 8px;
            max-width: 400px;
            font-size: 18px;
            font-weight: bold;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .feedback-success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        .feedback-error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        #hint {
            margin-top: 10px;
            font-size: 18px;
            color: #1e3a8a;
            font-weight: bold;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .MathJax {
            font-family: Arial, sans-serif;
            font-size: 1.1em !important;
            color: #ffff00 !important;
            font-weight: bold !important;
        }
        @media (max-width: 768px) {
            body {
                margin: 10px;
            }
            canvas {
                width: 400px !important;
                height: 400px !important;
            }
            .complex-label {
                gap: 8px;
            }
            .icon {
                font-size: 20px;
            }
            .label-text {
                font-size: 16px;
            }
            .complex-number {
                font-size: 14px;
                padding: 6px 12px;
            }
            .controls button {
                padding: 8px 15px;
                font-size: 14px;
            }
            #feedback {
                font-size: 16px;
                padding: 12px;
                max-width: 90%;
            }
            #hint {
                font-size: 16px;
            }
            .MathJax {
                font-size: 0.8em !important;
            }
        }
    </style>
</head>
<body>
    <button class="close-btn" onclick="closeExercise()" aria-label="–ó–∞–∫—Ä–∏—Ç–∏ —Ç–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ p4">‚úñ –ó–∞–∫—Ä–∏—Ç–∏</button>
    <div class="complex-label">
        <span class="icon">üîπ</span>
        <span class="label-text">–ö–æ–º–ø–ª–µ–∫—Å–Ω–µ —á–∏—Å–ª–æ 1:</span>
        <span class="complex-number" id="z1"></span>
    </div>
    <div class="complex-label">
        <span class="icon">üîπ</span>
        <span class="label-text">–ö–æ–º–ø–ª–µ–∫—Å–Ω–µ —á–∏—Å–ª–æ 2:</span>
        <span class="complex-number" id="z2"></span>
    </div>
    <div style="position: relative; display: inline-block; margin-top: 20px;">
        <canvas id="complexPlane" width="600" height="600"></canvas>
        <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-weight: bold;">y (Im z)</div>
        <div style="position: absolute; bottom: 292px; right: -70px; font-weight: bold;">x (Re z)</div>
    </div>
    <div id="hint">–ú–∞–ª—é–π—Ç–µ z‚ÇÅ</div>
    <div class="controls">
        <button id="checkDiff" disabled>–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä—ñ–∑–Ω–∏—Ü—é</button>
        <button onclick="clearCanvas()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        <button id="nextNumbers" disabled>–ù–∞—Å—Ç—É–ø–Ω—ñ —á–∏—Å–ª–∞</button>
    </div>
    <div id="feedback"></div>
<script>
document.addEventListener("DOMContentLoaded", () => {
    console.log('vpr4.html –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
    document.body.classList.add('loaded');

    const canvas = document.getElementById("complexPlane");
    const ctx = canvas.getContext("2d");
    if (!ctx) {
        console.error('–ö–æ–Ω—Ç–µ–∫—Å—Ç canvas –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π');
        alert('–ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ canvas. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –±—Ä–∞—É–∑–µ—Ä.');
        return;
    }
    const z1El = document.getElementById("z1");
    const z2El = document.getElementById("z2");
    const checkDiffBtn = document.getElementById("checkDiff");
    const nextNumbersBtn = document.getElementById("nextNumbers");
    const feedbackEl = document.getElementById("feedback");
    const hintEl = document.getElementById("hint");

    if (!z1El || !z2El || !checkDiffBtn || !nextNumbersBtn || !feedbackEl || !hintEl) {
        console.error('–û–¥–∏–Ω –∞–±–æ –∫—ñ–ª—å–∫–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ DOM –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        alert('–ü–æ–º–∏–ª–∫–∞: –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∏.');
        return;
    }

    let canvasWidth = window.innerWidth <= 768 ? 400 : 600;
    let canvasHeight = canvasWidth;
    canvas.width = canvasWidth;
    canvas.height = canvasHeight;
    const origin = { x: canvasWidth / 2, y: canvasHeight / 2 };
    const scale = window.innerWidth <= 768 ? 20 : 25;

    let z1, z2;
    function generateComplexNumbers() {
        let valid = false;
        while (!valid) {
            z1 = { re: Math.floor(Math.random() * 19) - 9, im: Math.floor(Math.random() * 19) - 9 };
            z2 = { re: Math.floor(Math.random() * 19) - 9, im: Math.floor(Math.random() * 19) - 9 };
            const diffRe = z1.re - z2.re;
            const diffIm = z1.im - z2.im;
            if (diffRe >= -10 && diffRe <= 10 && diffIm >= -10 && diffIm <= 10 && (z1.re !== 0 || z1.im !== 0) && (z2.re !== 0 || z2.im !== 0)) {
                valid = true;
            }
        }
        z1El.innerHTML = `\\( z_1 = ${z1.re}${z1.im >= 0 ? '+' : ''}${z1.im}i \\)`;
        z2El.innerHTML = `\\( z_2 = ${z2.re}${z2.im >= 0 ? '+' : ''}${z2.im}i \\)`;
        console.log('–ù–æ–≤—ñ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ñ —á–∏—Å–ª–∞:', { z1, z2, diff: { re: z1.re - z2.re, im: z1.im - z2.im } });

        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise().then(() => {
                z1El.classList.add('rendered');
                z2El.classList.add('rendered');
                console.log('MathJax –æ–±—Ä–æ–±–ª–µ–Ω–æ');
            }).catch(err => console.error('–ü–æ–º–∏–ª–∫–∞ MathJax:', err));
        } else {
            console.error('MathJax –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
            z1El.textContent = `z1 = ${z1.re}${z1.im >= 0 ? '+' : ''}${z1.im}i`;
            z2El.textContent = `z2 = ${z2.re}${z2.im >= 0 ? '+' : ''}${z2.im}i`;
            z1El.classList.add('rendered');
            z2El.classList.add('rendered');
        }
    }
    generateComplexNumbers();

    let vector1 = null, vector2 = null, vectorNegZ2 = null, vector3 = null;
    let drawingStep = 'z1';
    let resultStart = null;
    let animationId = null;
    let showCorrectDiff = false;
    let parallelogramOpacity = 1;

    function updateHint() {
        console.log('–û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥–∫–∞–∑–∫–∏:', drawingStep);
        if (drawingStep === 'z1') hintEl.textContent = '–ú–∞–ª—é–π—Ç–µ z‚ÇÅ';
        else if (drawingStep === 'z2') hintEl.textContent = '–ú–∞–ª—é–π—Ç–µ z‚ÇÇ';
        else if (drawingStep === 'neg_z2') hintEl.textContent = '–ú–∞–ª—é–π—Ç–µ -z‚ÇÇ';
        else if (drawingStep === 'result_start') hintEl.textContent = '–£–∫–∞–∂—ñ—Ç—å –ø–æ—á–∞—Ç–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É';
        else if (drawingStep === 'result_end') hintEl.textContent = '–£–∫–∞–∂—ñ—Ç—å –∫—ñ–Ω–µ—Ü—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É';
        else hintEl.textContent = '';
    }

    function drawGrid() {
        ctx.save();
        ctx.clearRect(0, 0, canvasWidth, canvasHeight);
        ctx.strokeStyle = "#ccc";
        ctx.lineWidth = 1;
        for (let x = 0; x <= canvasWidth; x += scale) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvasHeight);
            ctx.stroke();
        }
        for (let y = 0; y <= canvasHeight; y += scale) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvasWidth, y);
            ctx.stroke();
        }
        ctx.restore();
    }

    function drawAxes() {
        drawGrid();
        ctx.save();
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, origin.y);
        ctx.lineTo(canvasWidth, origin.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(canvasWidth - 15, origin.y - 7);
        ctx.lineTo(canvasWidth, origin.y);
        ctx.lineTo(canvasWidth - 15, origin.y + 7);
        ctx.fillStyle = "#000";
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(origin.x, 0);
        ctx.lineTo(origin.x, canvasHeight);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(origin.x - 7, 15);
        ctx.lineTo(origin.x, 0);
        ctx.lineTo(origin.x + 7, 15);
        ctx.fill();
        ctx.font = window.innerWidth <= 768 ? "14px Arial" : "16px Arial";
        ctx.fillStyle = "#444";
        for (let i = -11; i <= 11; i++) {
            if (i !== 0) {
                ctx.fillText(i, origin.x + i * scale - 10, origin.y + 18);
                ctx.fillText(-i, origin.x + 10, origin.y + i * scale + 10);
            }
        }
        ctx.restore();
    }

    function drawVector(startX, startY, endX, endY, color, label, dashed = false, isSegment = false, opacity = 1) {
        ctx.save();
        ctx.globalAlpha = opacity;
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        if (dashed) ctx.setLineDash([5, 3]);
        ctx.moveTo(startX, startY);
        ctx.lineTo(endX, endY);
        ctx.stroke();
        if (dashed) ctx.setLineDash([]);
        
        if (!isSegment) {
            const angle = Math.atan2(endY - startY, endX - startX);
            const arrowSize = 10;
            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - arrowSize * Math.cos(angle - Math.PI / 6), endY - arrowSize * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - arrowSize * Math.cos(angle + Math.PI / 6), endY - arrowSize * Math.sin(angle + Math.PI / 6));
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(endX, endY, 5, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
        }
        
        if (label) {
            ctx.font = "16px Arial";
            ctx.fillStyle = color;
            if (label === "z‚ÇÅ-z‚ÇÇ") {
                const offsetX = endX + (endX > startX ? 15 : -30);
                const offsetY = endY + (endY > startY ? -5 : 30);
                ctx.fillText(label, offsetX, offsetY);
            } else {
                ctx.fillText(label, endX + 15, endY - 5);
            }
        }
        ctx.restore();
    }

    function render() {
        console.log('–†–µ–Ω–¥–µ—Ä–∏–Ω–≥:', { vector1, vector2, vectorNegZ2, vector3, showCorrectDiff, drawingStep, parallelogramOpacity });
        drawAxes();
        if (vector1) {
            drawVector(origin.x, origin.y, origin.x + vector1.re * scale, origin.y - vector1.im * scale, "#008080", "z‚ÇÅ");
        }
        if (vector2) {
            drawVector(origin.x, origin.y, origin.x + vector2.re * scale, origin.y - vector2.im * scale, "#00FF00", "z‚ÇÇ");
        }
        if (vectorNegZ2) {
            drawVector(origin.x, origin.y, origin.x + vectorNegZ2.re * scale, origin.y - vectorNegZ2.im * scale, "#FFA500", "-z‚ÇÇ", true);
            drawVector(
                origin.x + vector1.re * scale,
                origin.y - vector1.im * scale,
                origin.x + (vector1.re + vectorNegZ2.re) * scale,
                origin.y - (vector1.im + vectorNegZ2.im) * scale,
                "#800080", null, true, true, parallelogramOpacity
            );
            drawVector(
                origin.x + vectorNegZ2.re * scale,
                origin.y - vectorNegZ2.im * scale,
                origin.x + (vector1.re + vectorNegZ2.re) * scale,
                origin.y - (vector1.im + vectorNegZ2.im) * scale,
                "#800080", null, true, true, parallelogramOpacity
            );
        }
        if (vector3 && drawingStep !== 'result_start') {
            const startX = origin.x + vector3.startRe * scale;
            const startY = origin.y - vector3.startIm * scale;
            const endX = origin.x + vector3.endRe * scale;
            const endY = origin.y - vector3.endIm * scale;
            drawVector(startX, startY, endX, endY, "#00008B", null, true);
        }
        if (showCorrectDiff && drawingStep !== 'animating_correct') {
            drawVector(
                origin.x, origin.y,
                origin.x + (z1.re - z2.re) * scale,
                origin.y - (z1.im - z2.im) * scale,
                "#FF0000", "z‚ÇÅ-z‚ÇÇ"
            );
        }
    }

    function showFeedback(message, isCorrect) {
        console.log('showFeedback:', { message, isCorrect });
        feedbackEl.textContent = message;
        feedbackEl.className = isCorrect ? 'feedback-success' : 'feedback-error';
        feedbackEl.style.display = 'block';
        setTimeout(() => {
            feedbackEl.style.display = 'none';
            feedbackEl.textContent = '';
        }, 2000);
    }

    function animateVector3Transfer(callback) {
        if (!vector3) {
            callback();
            return;
        }
        const isOrigin = Math.abs(vector3.startRe) < 0.5 && Math.abs(vector3.startIm) < 0.5;
        if (isOrigin) {
            callback();
            return;
        }

        let t = 0;
        const duration = 1000;
        function step() {
            t += 16;
            const progress = Math.min(t / duration, 1);
            const currentStartRe = vector3.startRe * (1 - progress);
            const currentStartIm = vector3.startIm * (1 - progress);
            const currentEndRe = vector3.endRe - vector3.startRe * progress;
            const currentEndIm = vector3.endIm - vector3.startIm * progress;

            render();
            ctx.save();
            ctx.beginPath();
            ctx.strokeStyle = "#00008B";
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 3]);
            ctx.moveTo(origin.x + currentStartRe * scale, origin.y - currentStartIm * scale);
            ctx.lineTo(origin.x + currentEndRe * scale, origin.y - currentEndIm * scale);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.restore();

            if (progress < 1) {
                animationId = requestAnimationFrame(step);
            } else {
                vector3.startRe = 0;
                vector3.startIm = 0;
                vector3.endRe = vector3.endRe - vector3.startRe;
                vector3.endIm = vector3.endIm - vector3.startIm;
                vector3.re = vector3.endRe;
                vector3.im = vector3.endIm;
                render();
                animationId = null;
                callback();
            }
        }
        animationId = requestAnimationFrame(step);
    }

    function animateVector3Solid() {
        let t = 0;
        const duration = 1000;
        function step() {
            t += 16;
            const progress = Math.min(t / duration, 1);
            render();
            ctx.save();
            ctx.beginPath();
            ctx.strokeStyle = "#00008B";
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 3]);
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(
                origin.x + vector3.re * scale * progress,
                origin.y - vector3.im * scale * progress
            );
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.restore();

            if (progress < 1) {
                animationId = requestAnimationFrame(step);
            } else {
                drawingStep = 'checking';
                checkDiffBtn.classList.add('pulse');
                checkDiffBtn.disabled = false;
                render();
                animationId = null;
            }
        }
        animationId = requestAnimationFrame(step);
    }

    function animateParallelogramFadeOut(callback) {
        let t = 0;
        const duration = 1000;
        function step() {
            t += 16;
            const progress = Math.min(t / duration, 1);
            parallelogramOpacity = 1 - progress;
            render();
            if (progress < 1) {
                animationId = requestAnimationFrame(step);
            } else {
                parallelogramOpacity = 0;
                render();
                animationId = null;
                if (callback) callback();
            }
        }
        animationId = requestAnimationFrame(step);
    }

    function animateCorrectDiff() {
        let t = 0;
        const duration = 1500;
        function step() {
            t += 16;
            const progress = Math.min(t / duration, 1);
            render();
            ctx.save();
            ctx.beginPath();
            ctx.strokeStyle = "#FF0000";
            ctx.lineWidth = 3;
            ctx.setLineDash([]);
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(
                origin.x + (z1.re - z2.re) * scale * progress,
                origin.y - (z1.im - z2.im) * scale * progress
            );
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.restore();

            if (progress >= 1) {
                const isCorrect = vector3 &&
                    Math.abs(vector1.re - z1.re) <= 0.5 &&
                    Math.abs(vector1.im - z1.im) <= 0.5 &&
                    Math.abs(vector2.re - z2.re) <= 0.5 &&
                    Math.abs(vector2.im - z2.im) <= 0.5 &&
                    Math.abs(vectorNegZ2.re - (-z2.re)) <= 0.5 &&
                    Math.abs(vectorNegZ2.im - (-z2.im)) <= 0.5 &&
                    Math.abs(vector3.endRe - (z1.re - z2.re)) <= 0.5 &&
                    Math.abs(vector3.endIm - (z1.im - z2.im)) <= 0.5;
                showFeedback(isCorrect ? '‚úÖ –ú–æ–ª–æ–¥–µ—Ü—å!' : '‚ùå –†—ñ–∑–Ω–∏—Ü—è –Ω–µ–≤—ñ—Ä–Ω–∞!', isCorrect);
                drawingStep = null;
                checkDiffBtn.classList.remove('pulse');
                checkDiffBtn.disabled = true;
                nextNumbersBtn.disabled = !isCorrect;
                if (isCorrect) {
                    animateParallelogramFadeOut(() => {
                        console.log('–ü–∞—Ä–∞–ª–µ–ª–æ–≥—Ä–∞–º –∑–Ω–∏–∫');
                    });
                } else {
                    render();
                }
                animationId = null;
            } else {
                animationId = requestAnimationFrame(step);
            }
        }
        animationId = requestAnimationFrame(step);
    }

    canvas.addEventListener("click", (event) => {
        if (drawingStep === 'animating' || drawingStep === 'checking' || drawingStep === 'animating_correct') return;
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        const point = {
            re: Math.round((x - origin.x) / scale),
            im: -Math.round((y - origin.y) / scale)
        };
        console.log(`–ö–ª—ñ–∫: drawingStep=${drawingStep}, point={re: ${point.re}, im: ${point.im}}`);

        if (drawingStep === 'z1') {
            vector1 = point;
            const isCorrect = Math.abs(point.re - z1.re) <= 0.5 && Math.abs(point.im - z1.im) <= 0.5;
            showFeedback(isCorrect ? '‚úÖ –í—ñ—Ä–Ω–æ!' : '‚ùå –ù–µ–≤—ñ—Ä–Ω–æ!', isCorrect);
            if (!isCorrect) {
                vector1 = null;
            } else {
                drawingStep = 'z2';
            }
        } else if (drawingStep === 'z2') {
            vector2 = point;
            const isCorrect = Math.abs(point.re - z2.re) <= 0.5 && Math.abs(point.im - z2.im) <= 0.5;
            showFeedback(isCorrect ? '‚úÖ –í—ñ—Ä–Ω–æ!' : '‚ùå –ù–µ–≤—ñ—Ä–Ω–æ!', isCorrect);
            if (!isCorrect) {
                vector2 = null;
            } else {
                drawingStep = 'neg_z2';
            }
        } else if (drawingStep === 'neg_z2') {
            vectorNegZ2 = point;
            const isCorrect = Math.abs(point.re - (-z2.re)) <= 0.5 && Math.abs(point.im - (-z2.im)) <= 0.5;
            showFeedback(isCorrect ? '‚úÖ –í—ñ—Ä–Ω–æ!' : '‚ùå –ù–µ–≤—ñ—Ä–Ω–æ!', isCorrect);
            if (!isCorrect) {
                vectorNegZ2 = null;
            } else {
                drawingStep = 'result_start';
            }
        } else if (drawingStep === 'result_start') {
            resultStart = point;
            vector3 = {
                startRe: resultStart.re,
                startIm: resultStart.im,
                endRe: resultStart.re,
                endIm: resultStart.im,
                re: 0,
                im: 0,
                isValid: false
            };
            drawingStep = 'result_end';
        } else if (drawingStep === 'result_end') {
            vector3.endRe = point.re;
            vector3.endIm = point.im;
            vector3.re = point.re - vector3.startRe;
            vector3.im = point.im - vector3.startIm;
            drawingStep = 'animating';
            animateVector3Transfer(animateVector3Solid);
        }
        render();
        updateHint();
    });

    checkDiffBtn.addEventListener("click", () => {
        if (drawingStep !== 'checking') {
            console.log('checkDiffBtn: –ö–Ω–æ–ø–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, drawingStep=', drawingStep);
            return;
        }
        console.log('checkDiffBtn: –ó–∞–ø—É—Å–∫ –∞–Ω—ñ–º–∞—Ü—ñ—ó –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Ä—ñ–∑–Ω–∏—Ü—ñ');
        showCorrectDiff = true;
        drawingStep = 'animating_correct';
        animateCorrectDiff();
    });

    nextNumbersBtn.addEventListener("click", () => {
        console.log('nextNumbersBtn: –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –Ω–æ–≤–∏—Ö —á–∏—Å–µ–ª');
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        vector1 = null;
        vector2 = null;
        vectorNegZ2 = null;
        vector3 = null;
        resultStart = null;
        showCorrectDiff = false;
        parallelogramOpacity = 1;
        drawingStep = 'z1';
        checkDiffBtn.classList.remove('pulse');
        checkDiffBtn.disabled = true;
        nextNumbersBtn.disabled = true;
        feedbackEl.style.display = "none";
        z1El.classList.remove('rendered');
        z2El.classList.remove('rendered');
        generateComplexNumbers();
        render();
        updateHint();
    });

    window.clearCanvas = function() {
        console.log('clearCanvas');
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
            console.log('–ê–Ω—ñ–º–∞—Ü—ñ—é –∑—É–ø–∏–Ω–µ–Ω–æ');
        }
        vector1 = null;
        vector2 = null;
        vectorNegZ2 = null;
        vector3 = null;
        resultStart = null;
        showCorrectDiff = false;
        parallelogramOpacity = 1;
        drawingStep = 'z1';
        checkDiffBtn.classList.remove('pulse');
        checkDiffBtn.disabled = true;
        nextNumbersBtn.disabled = true;
        feedbackEl.style.display = "none";
        feedbackEl.textContent = '';
        render();
        updateHint();
    };

   window.closeExercise = function() {
    console.log('closeExercise: –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è');
    const redirectUrl = "{{ url_for('p4') }}?openExamplesModal=true";
    try {
        window.location.href = redirectUrl;
    } catch (e) {
        console.error('closeExercise: –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:', e);
        alert('–ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É –∑–∞–≤–¥–∞–Ω—å.');
    }
};

    window.addEventListener('resize', () => {
        canvasWidth = window.innerWidth <= 768 ? 400 : 600;
        canvasHeight = canvasWidth;
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        render();
    });

    const styleSheet = document.createElement('style');
    styleSheet.innerText = `
        .pulse {
            animation: pulseButton 1s infinite;
        }
        @keyframes pulseButton {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }`;
    document.head.appendChild(styleSheet);

    render();
    updateHint();
});
</script>
</body>
</html>
